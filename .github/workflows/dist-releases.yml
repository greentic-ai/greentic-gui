name: dist (binstall-ready releases)

on:
  push:
    branches: [master]
    tags: ["v*.*.*"]

permissions:
  contents: write

concurrency:
  group: dist-releases-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish-crate:
    name: publish crate to crates.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.89.0"

      - name: Publish greentic-gui to crates.io (tags only)
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          cargo publish --locked

  # Build binstall-friendly artifacts after crates.io publish succeeds (or is skipped).
  build:
    name: build ${{ matrix.target }}
    runs-on: ${{ matrix.runs_on }}
    needs: [publish-crate]
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            runs_on: ubuntu-latest
          - target: x86_64-pc-windows-msvc
            runs_on: windows-latest
          - target: x86_64-apple-darwin
            # Prefer the recommended Intel image for x86_64 macOS builds.
            runs_on: macos-15-intel
          - target: aarch64-apple-darwin
            # Prefer the recommended Apple Silicon image.
            runs_on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.89.0"
          targets: ${{ matrix.target }}

      - name: Cache cargo registry + build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-dist
        shell: bash
        run: |
          set -euo pipefail
          cargo install cargo-dist --locked --version 0.28.0
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

      - name: Build dist artifacts
        shell: bash
        run: |
          set -euo pipefail
          dist --version
          dist build --target ${{ matrix.target }}

      - name: Collect artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist-artifacts

          candidates=(dist target/dist target/distrib target/distribs target/distributable)
          copied=0

          for d in "${candidates[@]}"; do
            if [[ -d "$d" ]]; then
              while IFS= read -r -d '' f; do
                cp -f "$f" dist-artifacts/
                copied=$((copied + 1))
              done < <(find "$d" -maxdepth 3 -type f \( -name '*.tar.gz' -o -name '*.zip' -o -name '*.sha256' -o -name '*.sha512' -o -name '*.json' \) -print0)
            fi
          done

          if [[ "$copied" -eq 0 ]]; then
            echo "No dist artifacts found; expected outputs under dist/ or target/*." >&2
            find . -maxdepth 4 -type d -print
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.target }}
          path: dist-artifacts/*
          if-no-files-found: error

  publish:
    name: publish release
    runs-on: ubuntu-latest
    needs: [build, publish-crate]
    steps:
      - name: Checkout repo (for git context/GH CLI)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: dist-*
          path: release-artifacts
          merge-multiple: true

      - name: Publish GitHub Release (nightly or tag)
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            tag="${GITHUB_REF_NAME}"
            title="greentic-gui ${tag}"
            prerelease_flag=""
          else
            tag="nightly"
            title="Nightly"
            prerelease_flag="--prerelease"

            # Force-move (or create) the nightly tag to this commit.
            if gh api "repos/${GITHUB_REPOSITORY}/git/refs/tags/${tag}" >/dev/null 2>&1; then
              gh api -X PATCH "repos/${GITHUB_REPOSITORY}/git/refs/tags/${tag}" -f sha="${GITHUB_SHA}" -F force=true >/dev/null
            else
              gh api -X POST "repos/${GITHUB_REPOSITORY}/git/refs" -f ref="refs/tags/${tag}" -f sha="${GITHUB_SHA}" -F force=true >/dev/null
            fi
          fi

          if gh release view "${tag}" >/dev/null 2>&1; then
            gh release edit "${tag}" --title "${title}" ${prerelease_flag}
          else
            if [[ "${tag}" == "nightly" ]]; then
              gh release create "${tag}" --title "${title}" --prerelease --target "${GITHUB_SHA}" --notes "Automated nightly build from master."
            else
              gh release create "${tag}" --title "${title}" --target "${GITHUB_SHA}" --generate-notes
            fi
          fi

          mapfile -d '' files < <(find release-artifacts -type f -maxdepth 4 -print0)
          if [[ "${#files[@]}" -eq 0 ]]; then
            echo "No release artifacts found to upload." >&2
            exit 1
          fi

          gh release upload "${tag}" "${files[@]}" --clobber
